import { Effect } from 'effect'
import { beforeEach, describe, expect, it } from 'vitest'
import { SwOSClient } from '../core/swos-client.js'
import { PoeMode, PoeStatus } from '../types/link.js'
import { http, HttpResponse, server } from './setup.js'

describe('LinkPage', () => {
  let client: SwOSClient

  beforeEach(() => {
    client = new SwOSClient('192.168.1.4', 'admin', 'password')
  })

  it('should load link data from real device response', async () => {
    // Mock the response based on real device
    const rawResponse =
      '{en:"0x3f",lnk:"0x1e",dpx:"0x2e",dpxc:"0x3f",fct:"0x3f",an:"0x3f",poe:["0x0","0x0","0x0","0x0","0x0","0x0"],prio:["0x0","0x0","0x0","0x0","0x0","0x0"],poes:["0x0","0x0","0x0","0x0","0x0","0x0"],spdc:["0x0","0x0","0x0","0x0","0x0","0x0"],pwr:["0x0","0x0","0x0","0x0","0x0","0x0"],curr:["0x0","0x0","0x0","0x0","0x0","0x0"],nm:["506f7274310a","506f7274320a","506f7274330a","506f7274340a","506f7274350a","5366700a"],spd:["0x0","0x0","0x0","0x0","0x0","0x0"]}'

    server.use(
      http.get('http://192.168.1.4/link.b', () => {
        return HttpResponse.text(rawResponse)
      })
    )

    const links = await Effect.runPromise(client.links.load())

    expect(links).toHaveLength(6)
    expect(links[0]).toMatchObject({
      name: 'Port1\n',
      enabled: true,
      linkUp: false,
      duplex: false,
      duplexControl: true,
      flowControl: true,
      autoNegotiation: true,
      poeMode: PoeMode.Off,
      poePrio: 0,
      poeStatus: PoeStatus.Unavailable,
      speedControl: 0,
      power: 0,
      current: 0,
    })
    expect(links[1]).toMatchObject({
      name: 'Port2\n',
      linkUp: true,
      duplex: true,
    })
    expect(links[5]).toMatchObject({
      name: 'Sfp\n',
      duplex: true,
    })
  })

  it('should save link data', async () => {
    // Mock initial load
    const rawResponse =
      '{en:"0x3f",lnk:"0x1e",dpx:"0x2e",dpxc:"0x3f",fct:"0x3f",an:"0x3f",poe:["0x0","0x0","0x0","0x0","0x0","0x0"],prio:["0x0","0x0","0x0","0x0","0x0","0x0"],poes:["0x0","0x0","0x0","0x0","0x0","0x0"],spdc:["0x0","0x0","0x0","0x0","0x0","0x0"],pwr:["0x0","0x0","0x0","0x0","0x0","0x0"],curr:["0x0","0x0","0x0","0x0","0x0","0x0"],nm:["506f7274310a","506f7274320a","506f7274330a","506f7274350a","506f7274350a","5366700a"],spd:["0x0","0x0","0x0","0x0","0x0","0x0"]}'

    server.use(
      http.get('http://192.168.1.4/link.b', () => {
        return HttpResponse.text(rawResponse)
      }),
      http.post('http://192.168.1.4/link.b', async ({ request }) => {
        const body = await request.text()
        // Decode body to check content.
        // Expected payload based on modified state.
        // If we disable port 1 (index 0), 'en' should become 0x3E (111110)
        expect(body).toContain('en:0x3E')
        return HttpResponse.text(rawResponse) // Return same state or updated one
      })
    )

    // Initial Load
    const links = await Effect.runPromise(client.links.load())

    // Modify
    if (links[0]) {
      links[0].enabled = false
    }

    // Save
    await Effect.runPromise(client.links.save(links))
  })

  it('should save links successfully', async () => {
    const rawResponseStr =
      '{en:"0x3f",lnk:"0x1e",dpx:"0x2e",dpxc:"0x3f",fct:"0x3f",an:"0x3f",poe:["0x0","0x0","0x0","0x0","0x0","0x0"],prio:["0x0","0x0","0x0","0x0","0x0","0x0"],poes:["0x0","0x0","0x0","0x0","0x0","0x0"],spdc:["0x0","0x0","0x0","0x0","0x0","0x0"],pwr:["0x0","0x0","0x0","0x0","0x0","0x0"],curr:["0x0","0x0","0x0","0x0","0x0","0x0"],nm:["506f7274310a","506f7274320a","506f7274330a","506f7274350a","506f7274350a","5366700a"],spd:["0x0","0x0","0x0","0x0","0x0","0x0"]}'

    server.use(
      http.get('http://192.168.88.1/link.b', () => {
        return HttpResponse.text(rawResponseStr)
      }),
      http.post('http://192.168.88.1/link.b', async ({ request }) => {
        const body = await request.text()
        expect(body).toContain('nm')
        expect(body).toContain('en:0x3F') // Check enabled mask
        return HttpResponse.text(rawResponseStr)
      })
    )

    const client = new SwOSClient('192.168.88.1', 'admin', '')
    // Load initial state
    const links = await Effect.runPromise(client.links.load())

    // Modify a link
    if (links[0]) {
      links[0].enabled = true
    }

    await Effect.runPromise(client.links.save(links))
  })

  it('should handle response missing PoE fields', async () => {
    // Response provided by user, missing poe, prio, poes, pwr, curr
    const rawResponse = `{
      comb:0x00000000,qsfp:0x00000000,en:0x03ffffff,blkp:0x00000000,an:0x03ffffff,dpxc:0x03ffffff,fctc:0x03ffffff,fctr:0x00000000,lnk:0x006058fb,dpx:0x006058fb,tfct:0x00600801,rfct:0x00000000,paus:0x00000000,
      spd:[0x02,0x02,0x07,0x02,0x02,0x02,0x02,0x02,0x07,0x07,0x07,0x02,0x02,0x07,0x00,0x07,0x07,0x07,0x07,0x07,0x07,0x02,0x01,0x07,0x07,0x07],
      spdc:[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
      cm:[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
      qtyp:[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
      prt:0x1a,sfp:0x02,sfpo:0x18,
      nm:['6f6e742d6f7574','726f757465722d6f7574','506f727433','726f757465722d696e','55702d6170','30702d6170','31702d6170','32702d6170','506f727439','506f72743130','506f72743131','6c6f756e6765','6f6666696365','73746173696f','6b696473','6775657374','506f72743137','736174656c2d6574684d','506f72743139','506f72743230','506f72743231','506f72743232','506f72743233','506f72743234','53465031','53465032'],
      hop:[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
      hops:[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
      len:[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
      flt:[0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
      pair:[0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff]
    }`

    server.use(
      http.get('http://192.168.1.4/link.b', () => {
        return HttpResponse.text(rawResponse)
      })
    )

    const links = await Effect.runPromise(client.links.load())
    expect(links.length).toBeGreaterThan(0)
    // Check missing fields are defaulted
    expect(links[0].poeMode).toBe(PoeMode.Off)
    expect(links[0].power).toBe(0)
  })

  it('should load data using async wrapper method', async () => {
    const rawResponse =
      '{en:"0x3f",lnk:"0x1e",dpx:"0x2e",dpxc:"0x3f",fct:"0x3f",an:"0x3f",poe:["0x0","0x0","0x0","0x0","0x0","0x0"],prio:["0x0","0x0","0x0","0x0","0x0","0x0"],poes:["0x0","0x0","0x0","0x0","0x0","0x0"],spdc:["0x0","0x0","0x0","0x0","0x0","0x0"],pwr:["0x0","0x0","0x0","0x0","0x0","0x0"],curr:["0x0","0x0","0x0","0x0","0x0","0x0"],nm:["506f7274310a","506f7274320a","506f7274330a","506f7274340a","506f7274350a","5366700a"],spd:["0x0","0x0","0x0","0x0","0x0","0x0"]}'

    server.use(
      http.get('http://192.168.1.4/link.b', () => {
        return HttpResponse.text(rawResponse)
      })
    )

    // Test using async method
    const links = await client.links.loadAsync()
    expect(links).toHaveLength(6)
    expect(links[0].name).toBe('Port1\n')
  })

  it('should save data using async wrapper method', async () => {
    const rawResponse =
      '{en:"0x3f",lnk:"0x1e",dpx:"0x2e",dpxc:"0x3f",fct:"0x3f",an:"0x3f",poe:["0x0","0x0","0x0","0x0","0x0","0x0"],prio:["0x0","0x0","0x0","0x0","0x0","0x0"],poes:["0x0","0x0","0x0","0x0","0x0","0x0"],spdc:["0x0","0x0","0x0","0x0","0x0","0x0"],pwr:["0x0","0x0","0x0","0x0","0x0","0x0"],curr:["0x0","0x0","0x0","0x0","0x0","0x0"],nm:["506f7274310a","506f7274320a","506f7274330a","506f7274350a","506f7274350a","5366700a"],spd:["0x0","0x0","0x0","0x0","0x0","0x0"]}'

    server.use(
      http.get('http://192.168.1.4/link.b', () => {
        return HttpResponse.text(rawResponse)
      }),
      http.post('http://192.168.1.4/link.b', async ({ request }) => {
        const body = await request.text()
        expect(body).toContain('en:0x3E')
        return HttpResponse.text(rawResponse)
      })
    )

    const links = await client.links.loadAsync()
    if (links[0]) {
      links[0].enabled = false
    }
    // Test using async method
    await client.links.saveAsync(links)
  })
})
